generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Brand {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  name         String
  slug         String   @unique
  description  String?
  domain       String?
  aliases      String[] @default([])
  domains      String[] @default([])
  competitors  String[] @default([])
  industry     String?
  color        String   @default("#6366f1")
  logoUrl      String?  @map("logo_url")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  prompts            Prompt[]
  alertRules         AlertRule[]
  monitoringResults  MonitoringResult[]
  alertEvents        AlertEvent[]
  healthScores       BrandHealthScore[]

  @@map("brands")
  @@index([userId])
  @@index([slug])
}

model Prompt {
  id           String   @id @default(uuid())
  brandId      String   @map("brand_id")
  userId       String   @map("user_id")
  text         String
  language     String   @default("en")
  market       String   @default("global")
  category     String?
  engines      String[] @default(["chatgpt", "gemini", "perplexity"])
  isActive     Boolean  @default(true) @map("is_active")
  runFrequency String   @default("daily") @map("run_frequency")
  lastRunAt    DateTime? @map("last_run_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  brand             Brand              @relation(fields: [brandId], references: [id], onDelete: Cascade)
  monitoringResults MonitoringResult[]

  @@map("prompts")
  @@index([brandId])
  @@index([userId])
}

model MonitoringResult {
  id                String   @id @default(uuid())
  promptId          String   @map("prompt_id")
  brandId           String   @map("brand_id")
  userId            String   @map("user_id")
  engine            String
  promptText        String   @map("prompt_text")
  responseText     String   @map("response_text")
  brandMentioned   Boolean  @default(false) @map("brand_mentioned")
  mentionPosition  Int?     @map("mention_position")
  mentionCount     Int      @default(0) @map("mention_count")
  mentionType      String?  @map("mention_type")
  visibilityScore  Int      @default(0) @map("visibility_score")
  sentiment        String?
  sentimentScore   Float?   @map("sentiment_score")
  citedUrls        String[] @default([]) @map("cited_urls")
  competitorMentions Json   @default([]) @map("competitor_mentions")
  hasHallucination Boolean  @default(false) @map("has_hallucination")
  hallucinationFlags Json   @default([]) @map("hallucination_flags")
  rawResponse      Json?    @map("raw_response")
  createdAt        DateTime @default(now()) @map("created_at")

  prompt Prompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  brand  Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@map("monitoring_results")
  @@index([brandId])
  @@index([promptId])
  @@index([engine])
  @@index([createdAt(sort: Desc)])
  @@index([userId])
}

model AlertRule {
  id           String    @id @default(uuid())
  brandId      String    @map("brand_id")
  userId       String    @map("user_id")
  name         String
  type         String
  condition    Json
  channels     String[]  @default(["email"])
  email        String?
  webhookUrl   String?   @map("webhook_url")
  isActive     Boolean   @default(true) @map("is_active")
  lastFiredAt DateTime? @map("last_fired_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  brand        Brand         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  alertEvents  AlertEvent[]

  @@map("alert_rules")
  @@index([brandId])
  @@index([userId])
}

model AlertEvent {
  id            String    @id @default(uuid())
  alertRuleId   String    @map("alert_rule_id")
  brandId       String    @map("brand_id")
  userId        String    @map("user_id")
  type          String
  title         String
  message       String
  data          Json      @default({})
  channelsSent  String[]  @default([]) @map("channels_sent")
  isRead        Boolean   @default(false) @map("is_read")
  createdAt     DateTime  @default(now()) @map("created_at")

  alertRule     AlertRule @relation(fields: [alertRuleId], references: [id], onDelete: Cascade)
  brand         Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@map("alert_events")
  @@index([userId])
  @@index([brandId])
  @@index([createdAt(sort: Desc)])
  @@index([isRead])
}

model BrandHealthScore {
  id                String   @id @default(uuid())
  brandId           String   @map("brand_id")
  userId            String   @map("user_id")
  date              DateTime @db.Date @default(now())
  visibilityScore   Float    @default(0) @map("visibility_score")
  sentimentScore    Float    @default(0) @map("sentiment_score")
  hallucinationRate Float    @default(0) @map("hallucination_rate")
  mentionCount      Int      @default(0) @map("mention_count")
  citationCount     Int      @default(0) @map("citation_count")
  healthScore       Float    @default(0) @map("health_score")
  engineBreakdown   Json     @default({}) @map("engine_breakdown")
  createdAt         DateTime @default(now()) @map("created_at")

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([brandId, date])
  @@map("brand_health_scores")
  @@index([brandId])
  @@index([date(sort: Desc)])
}

model Subscription {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  stripeCustomerId String?  @map("stripe_customer_id")
  stripeSubId     String?  @map("stripe_sub_id")
  plan            String   @default("free")
  status           String   @default("active")
  currentPeriodEnd DateTime? @map("current_period_end")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("subscriptions")
}

model ApiKey {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  key         String   @unique
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("api_keys")
  @@index([userId])
  @@index([key])
}
